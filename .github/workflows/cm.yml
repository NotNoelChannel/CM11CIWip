name: CyanogenMod CI

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-18.04

    steps:
      - name: Syncing Sources
        run: |
          mkdir ~/.bin
          mkdir ~/cm
          curl http://commondatastorage.googleapis.com/git-repo-downloads/repo > ~/.bin/repo
          cd ~/cm
          python3 ~/.bin/repo init --depth=1 -u https://github.com/CyanogenMod/android.git -b cm-14.1
          python3 ~/.bin/repo sync -c --force-sync --optimized-fetch --no-tags --no-clone-bundle --prune -j$(nproc --all)
      
      - name: Installing Build Dependencies
        run: |
          sudo apt-get install git-core gnupg flex bison build-essential \
            zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 \
            libncurses5 lib32ncurses5-dev x11proto-core-dev libx11-dev \
            lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip \
            fontconfig schedtool axel
      - name: Installing JDK 6 & Building CyanogenMod
        run: |
          mkdir ~/.jdk_6
          cd ~/.jdk_6
          axel -q -n $(nproc --all) https://repo.huaweicloud.com/java/jdk/6u45-b06/jdk-6u45-linux-x64.bin
          chmod +x jdk-6u45-linux-x64.bin
          ./jdk-6u45-linux-x64.bin
          sudo update-alternatives --install /usr/bin/javac javac  $PWD/jdk1.6.0_45/bin/javac 1
          sudo update-alternatives --set javac $PWD/jdk1.6.0_45/bin/javac
          sudo update-alternatives --install /usr/bin/java java  $PWD/jdk1.6.0_45/bin/java 1
          sudo update-alternatives --set java $PWD/jdk1.6.0_45/bin/java
          sudo update-alternatives --install /usr/bin/javaws javaws  $PWD/jdk1.6.0_45/bin/javaws 1
          sudo update-alternatives --set javaws $PWD/jdk1.6.0_45/bin/javaws
          sudo update-alternatives --install /usr/bin/javadoc javadoc  $PWD/jdk1.6.0_45/bin/javadoc 1
          sudo update-alternatives --set javadoc $PWD/jdk1.6.0_45/bin/javadoc
          sudo update-alternatives --install /usr/bin/javah javah  $PWD/jdk1.6.0_45/bin/javah 1
          sudo update-alternatives --set javah $PWD/jdk1.6.0_45/bin/javah
          sudo update-alternatives --install /usr/bin/javap javap  $PWD/jdk1.6.0_45/bin/javap 1
          sudo update-alternatives --set javap $PWD/jdk1.6.0_45/bin/javap
          sudo update-alternatives --install /usr/bin/jar jar  $PWD/jdk1.6.0_45/bin/jar 1
          sudo update-alternatives --set jar $PWD/jdk1.6.0_45/bin/jar
          
          cd ..
          cd ~/cm
          git clone https://github.com/LineageOS/android_device_oneplus_bacon -b cm-14.1 device/oneplus/bacon
          git clone https://github.com/LineageOS/android_kernel_oneplus_msm8974 -b cm-14.1 kernel/oneplus/msm8974
          git clone https://github.com/LineageOS/android_device_oppo_msm8974-common -b cm-14.1 device/oppo/msm8974-common
          git clone https://github.com/LineageOS/android_device_oppo_common -b cm-14.1 device/oppo/common
          source build/envsetup.sh
          export ALLOW_MISSING_DEPENDENCIES=true
          export LC_ALL=C
          lunch lineage_bacon-eng
          mka
      - name: Uploading Builds
        uses: actions/upload-artifact@v2
        with:
          name: cm_build
          path: /home/runner/cm/out/target/product/*/cm-*.zip
